<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>macOS Sonoma - Live Tahoe</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/apple.png">
    
    <style>
        /* ::::::::::::::::::::::::::::::::::::::::::::::::
           CORE OS STYLES & TYPOGRAPHY
        :::::::::::::::::::::::::::::::::::::::::::::::: */
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            --window-blur: blur(30px) saturate(180%);
            --dock-blur: blur(35px) saturate(160%);
            --menu-bar-height: 32px;
            --dock-height: 70px;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: var(--system-font);
            /* Force Mac cursor everywhere */
            cursor: url('https://cdn.custom-cursor.com/db/9753/32/apple-spinning-wait-cursor-pointer.png'), auto !important;
            user-select: none;
            -webkit-font-smoothing: antialiased;
        }

        body, html {
            width: 100%; height: 100%; overflow: hidden; position: relative;
            background: #000;
        }

        /* ::::::::::::::::::::::::::::::::::::::::::::::::
           LAYER 1: LIVE WALLPAPER DESKTOP
        :::::::::::::::::::::::::::::::::::::::::::::::: */
        #desktop-background {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            overflow: hidden;
        }
        
        #live-wallpaper {
            position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%;
            width: auto; height: auto; transform: translateX(-50%) translateY(-50%);
            z-index: 1;
        }

        #wallpaper-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            /* Subtle gradient to ensure menu bar readability over bright video parts */
            background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 20%);
        }

        /* ::::::::::::::::::::::::::::::::::::::::::::::::
           LAYER 2: MENU BAR
        :::::::::::::::::::::::::::::::::::::::::::::::: */
        #menu-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: var(--menu-bar-height);
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: var(--window-blur); -webkit-backdrop-filter: var(--window-blur);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; font-size: 13.5px; font-weight: 500; color: #222; z-index: 99999;
        }

        .menu-group { display: flex; gap: 18px; align-items: center; height: 100%; }
        .menu-item { cursor: default !important; }
        .apple-logo { font-size: 17px; padding-bottom: 2px; }
        .app-name { font-weight: 700; }
        
        .status-icon { font-size: 16px; }
        .control-center-icon { font-size: 18px; }

        /* ::::::::::::::::::::::::::::::::::::::::::::::::
           LAYER 3: WINDOW SYSTEM
        :::::::::::::::::::::::::::::::::::::::::::::::: */
        #window-layer {
            position: absolute; top: var(--menu-bar-height); left: 0; 
            width: 100%; height: calc(100% - var(--menu-bar-height) - var(--dock-height));
            z-index: 10; pointer-events: none; /* Allow clicks through to desktop if no window hit */
        }

        .mac-window {
            position: absolute; pointer-events: auto;
            width: 680px; height: 480px;
            background: rgba(245, 245, 247, 0.85);
            backdrop-filter: var(--window-blur); -webkit-backdrop-filter: var(--window-blur);
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3), 0 0 0 0.5px rgba(255,255,255,0.4) inset;
            display: flex; flex-direction: column; overflow: hidden;
            opacity: 0; transform: scale(0.95);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .mac-window.active { opacity: 1; transform: scale(1); }
        .mac-window.closing { opacity: 0; transform: scale(0.95); pointer-events: none;}

        /* Special Style for the Liquid Chat Window */
        .mac-window.liquid-type {
            background: transparent; backdrop-filter: none; box-shadow: none;
        }
        .liquid-container {
            position: relative; width: 100%; height: 100%;
            background: #1c1c1e; border-radius: 12px;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.15) inset;
        }
        #glcanvas-container {
            position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            z-index: 0; pointer-events: none;
        }
        .liquid-content-layer { position: relative; z-index: 2; display: flex; flex-direction: column; height: 100%; }


        /* Window Title Bar */
        .title-bar {
            height: 42px; flex-shrink: 0;
            display: flex; align-items: center; padding: 0 16px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: linear-gradient(to bottom, rgba(255,255,255,0.5), rgba(255,255,255,0.3));
        }
        .title-bar.dark {
            background: #2d2d2d; border-bottom: 1px solid #111; color: #ddd;
        }

        .traffic-lights { display: flex; gap: 8px; height: 100%; align-items: center; }
        .traffic-btn {
            width: 12px; height: 12px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 8px; color: rgba(0,0,0,0.5); opacity: 1;
            border: 0.5px solid rgba(0,0,0,0.15);
        }
        .traffic-lights:hover .traffic-btn-icon { opacity: 1; }
        .traffic-btn-icon { opacity: 0; transition: opacity 0.1s; }
        .tb-close { background: #ff5f56; border-color: #e0443e; }
        .tb-min { background: #ffbd2e; border-color: #dea123; }
        .tb-max { background: #27c93f; border-color: #1aab29; }

        .window-title-text {
            flex-grow: 1; text-align: center; font-weight: 600; font-size: 13px;
            color: rgba(0,0,0,0.85); margin-left: -60px; /* Offset for traffic lights */
        }
        .dark .window-title-text { color: rgba(255,255,255,0.9); }

        /* Window Content Area */
        .window-content {
            flex-grow: 1; position: relative; background: #fff; overflow: hidden;
        }
        .window-content.dark { background: #1e1e1e; color: #fff; }
        
        iframe.app-iframe { width: 100%; height: 100%; border: none; }
        /* The shield covers iframes during drag so mouse events don't get swallowed */
        .iframe-shield {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 999; display: none;
        }
        .mac-window.dragging .iframe-shield { display: block; }

        /* ::::::::::::::::::::::::::::::::::::::::::::::::
           LAYER 4: THE DOCK (FIXED, NOT AUTO-HIDE)
        :::::::::::::::::::::::::::::::::::::::::::::::: */
        #dock-container {
            position: absolute; bottom: 10px; left: 0; width: 100%;
            display: flex; justify-content: center; z-index: 10000;
        }
        
        #dock {
            display: flex; align-items: flex-end; gap: 8px;
            padding: 10px;
            height: var(--dock-height);
            background: rgba(245, 245, 245, 0.35);
            backdrop-filter: var(--dock-blur); -webkit-backdrop-filter: var(--dock-blur);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 24px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .dock-item {
            position: relative; width: 50px; height: 50px;
            display: flex; flex-direction: column; align-items: center;
            transition: transform 0.2s ease-out; margin-bottom: 5px;
        }
        
        /* Dock magnification effect on hover */
        .dock-item:hover { transform: scale(1.4) translateY(-15px); margin: 0 10px 5px 10px; }

        .dock-icon-img {
            width: 100%; height: 100%; object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .dock-dot {
            width: 4px; height: 4px; background: #444; border-radius: 50%;
            position: absolute; bottom: -8px; opacity: 0; transition: opacity 0.3s;
        }
        .dock-dot.active { opacity: 1; }

        .dock-separator {
            width: 1px; height: 40px; background: rgba(0,0,0,0.2);
            margin: 0 8px; align-self: center;
        }


        /* ::::::::::::::::::::::::::::::::::::::::::::::::
           CUSTOM APP STYLES
        :::::::::::::::::::::::::::::::::::::::::::::::: */
        /* Calculator Grid */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: 1.5fr repeat(5, 1fr); height: 100%; background: #333; gap: 1px; }
        .calc-display { grid-column: span 4; background: #222; color: white; font-size: 56px; display: flex; align-items: flex-end; justify-content: flex-end; padding: 20px; font-weight: 300; }
        .calc-btn { background: #555; color: white; border: none; font-size: 22px; cursor: default !important; }
        .calc-btn:active { background: #777; }
        .calc-btn.op { background: #ff9f0a; font-size: 28px; padding-bottom: 4px;} .calc-btn.op:active { background: #d48407; }
        .calc-btn.top { background: #444; }
        .calc-btn.zero { grid-column: span 2; text-align: left; padding-left: 25px;}

        /* Terminal */
        .terminal-wrap { background: #1e1e1e; color: #22c55e; padding: 15px; font-family: monospace; height: 100%; overflow-y: auto; font-size: 14px; }
        .term-input { background: transparent; border: none; color: #ddd; outline: none; font-family: monospace; width: 50%; }

        /* Notes */
        .notes-wrap { height: 100%; display: flex; }
        .notes-sidebar { width: 150px; background: #f5f5f7; border-right: 1px solid #ddd; padding: 15px; }
        .notes-editor { flex-grow: 1; padding: 20px; outline: none; border: none; resize: none; font-size: 16px; background: #fff; color: #222; font-family: -apple-system;}

    </style>
</head>
<body>

    <div id="desktop-background">
        <video id="live-wallpaper" autoplay loop muted playsinline>
            <source src="https://assets.mixkit.co/videos/preview/mixkit-waves-coming-to-the-beach-5016-large.mp4" type="video/mp4">
        </video>
        <div id="wallpaper-overlay"></div>
    </div>


    <div id="menu-bar">
        <div class="menu-group">
            <div class="menu-item apple-logo">Ô£ø</div>
            <div class="menu-item app-name" id="mb-app-name">Finder</div>
            <div class="menu-item">File</div>
            <div class="menu-item">Edit</div>
            <div class="menu-item">View</div>
            <div class="menu-item">Go</div>
            <div class="menu-item">Window</div>
            <div class="menu-item">Help</div>
        </div>
        <div class="menu-group">
            <div class="menu-item status-icon">üîã 100%</div>
            <div class="menu-item status-icon">üì∂</div>
            <div class="menu-item control-center-icon">üéõÔ∏è</div>
            <div class="menu-item" id="mb-clock">Wed Nov 8 9:41 AM</div>
        </div>
    </div>


    <div id="window-layer"></div>


    <div id="dock-container">
        <div id="dock">
            </div>
    </div>


    <script>
        /**
         * =========================================
         * SYSTEM CONFIGURATION & APP REGISTRY
         * =========================================
         * Defines all available applications, their icons, types, and content.
         * Using public domain icons/CDNs where possible for the simulation.
         */
        const ICON_BASE = "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/";
        
        const APP_REGISTRY = [
            // === Left Side Apps ===
            { id: 'finder', name: 'Finder', icon: ICON_BASE + 'finder.png', type: 'iframe', url: 'https://en.wikipedia.org/wiki/macOS' },
            { id: 'launchpad', name: 'Launchpad', icon: ICON_BASE + 'launchpad.png', type: 'static', html: '<div style="display:flex;height:100%;align-items:center;justify-content:center;font-size:30px;color:#888;">Apps Grid Placeholder</div>' },
            { id: 'safari', name: 'Safari', icon: ICON_BASE + 'safari.png', type: 'iframe', url: 'https://www.wikipedia.org', width: 900, height: 600 },
            { id: 'messages', name: 'Messages', icon: ICON_BASE + 'messages.png', type: 'static', html: '<div style="padding:20px;"><h3>iMessage</h3><hr><p><b>Craig:</b> The demo looks great!</p></div>' },
            { id: 'mail', name: 'Mail', icon: ICON_BASE + 'mail.png', type: 'static', html: '<div style="padding:20px;"><h3>Inbox (9,342)</h3><hr><p>Alert: Security threat...</p></div>' },
            { id: 'maps', name: 'Maps', icon: ICON_BASE + 'maps.png', type: 'iframe', url: 'https://www.openstreetmap.org/export/embed.html?bbox=-120.05%2C38.9%2C-119.9%2C39.1&layer=mapnik', width: 800, height: 600 }, // Tahoe area
            { id: 'photos', name: 'Photos', icon: ICON_BASE + 'photos.png', type: 'iframe', url: 'https://source.unsplash.com/random/800x600/?nature,water' },
            { id: 'facetime', name: 'FaceTime', icon: ICON_BASE + 'facetime.png', type: 'static', dark: true, html: '<div style="display:flex;height:100%;align-items:center;justify-content:center;background:#222;color:#555;">No Camera Detected</div>' },
            { id: 'calendar', name: 'Calendar', icon: ICON_BASE + 'calendar.png', type: 'static', html: '<div style="display:flex;height:100%;align-items:center;justify-content:center;font-size:80px;color:#e74c3c;">WED<br>8</div>' },
            { id: 'contacts', name: 'Contacts', icon: ICON_BASE + 'contacts.png', type: 'static', html: '<div style="padding:20px;"><b>All Contacts</b><hr>Apple Inc.<br>Doe, John</div>' },
            { id: 'reminders', name: 'Reminders', icon: ICON_BASE + 'reminders.png', type: 'static', html: '<ul style="padding:30px;line-height:2;"><li>‚úÖ Build massive JS OS</li><li>‚¨úÔ∏è Fix bugs</li></ul>' },
            { id: 'notes', name: 'Notes', icon: ICON_BASE + 'notes.png', type: 'custom_notes', width: 700, height: 500 },
            { id: 'tv', name: 'TV', icon: ICON_BASE + 'tv.png', type: 'iframe', url: 'https://www.youtube.com/embed/COKRY_08f2M', dark: true, width: 800, height: 450 },
            { id: 'music', name: 'Music', icon: ICON_BASE + 'music.png', type: 'iframe', url: 'https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M', dark: true, width: 400, height: 600 },
            { id: 'news', name: 'News', icon: ICON_BASE + 'news.png', type: 'iframe', url: 'https://www.bbc.com/news' },
            { id: 'stocks', name: 'Stocks', icon: ICON_BASE + 'stocks.png', type: 'iframe', dark: true, url: 'https://s.tradingview.com/embed-widget/mini-symbol-overview/?symbol=NASDAQ%3AAAPL&colorTheme=dark' },
            { id: 'calculator', name: 'Calculator', icon: ICON_BASE + 'calculator.png', type: 'custom_calc', dark: true, width: 300, height: 450 },
            // THE SPECIAL LIQUID CHAT APP
            { id: 'liquidchat', name: 'Liquid Chat', icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png', type: 'special_liquid', width: 440, height: 640 },
            
            // === Separator defined by null ===
            null, 
            
            // === Right Side Apps/Folders ===
            { id: 'downloads', name: 'Downloads', icon: 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png', type: 'static', html: 'Folder content...' },
            { id: 'terminal', name: 'Terminal', icon: ICON_BASE + 'terminal.png', type: 'custom_term', dark: true, width: 600, height: 400 },
            { id: 'trash', name: 'Trash', icon: ICON_BASE + 'trash.png', type: 'static', html: '<div style="display:flex;height:100%;align-items:center;justify-content:center;color:#888;">Trash is empty</div>' },
        ];


        /**
         * =========================================
         * WINDOW MANAGER SYSTEM (The Core Engine)
         * =========================================
         * Handles spawning, closing, dragging, and z-ordering of windows.
         */
        class WindowManager {
            constructor() {
                this.layer = document.getElementById('window-layer');
                this.windows = {}; // Track open window instances
                this.zIndexBase = 100;
                this.isDragging = false;
                this.dragTarget = null;
                this.dragOffset = { x:0, y:0 };

                // Global Mouse Listeners for Dragging
                document.addEventListener('mousemove', this.handleDragMove.bind(this));
                document.addEventListener('mouseup', this.handleDragEnd.bind(this));

                this.renderDock();
                this.startClock();
            }

            // --- System Init ---
            startClock() {
                const update = () => {
                    const now = new Date();
                    // Format: Wed Nov 8 9:41 AM
                    const options = { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' };
                    document.getElementById('mb-clock').innerText = now.toLocaleTimeString('en-US', options).replace(/,/g, '');
                };
                update();
                setInterval(update, 1000); // Update every second
            }

            renderDock() {
                const dockContainer = document.getElementById('dock');
                APP_REGISTRY.forEach(appData => {
                    if (appData === null) {
                        const sep = document.createElement('div');
                        sep.className = 'dock-separator';
                        dockContainer.appendChild(sep);
                    } else {
                        const item = document.createElement('div');
                        item.className = 'dock-item';
                        item.id = `dock-${appData.id}`;
                        item.onclick = () => this.openApp(appData.id);
                        item.innerHTML = `
                            <img class="dock-icon-img" src="${appData.icon}">
                            <div class="dock-dot" id="dot-${appData.id}"></div>
                        `;
                        dockContainer.appendChild(item);
                    }
                });
            }

            // --- Window Operations ---
            openApp(appId) {
                const appData = APP_REGISTRY.find(a => a && a.id === appId);
                if (!appData) return;

                // If already open, bring to front
                if (this.windows[appId]) {
                    this.bringToFront(appId);
                    return;
                }

                // Mark Dock Dot active
                document.getElementById(`dot-${appId}`).classList.add('active');

                // Create Window DOM Structure
                const win = document.createElement('div');
                win.className = `mac-window ${appData.type === 'special_liquid' ? 'liquid-type' : ''}`;
                win.id = `win-${appId}`;
                //Random spawn position
                win.style.left = `${100 + Math.random()*150}px`; 
                win.style.top = `${80 + Math.random()*100}px`;
                if(appData.width) win.style.width = `${appData.width}px`;
                if(appData.height) win.style.height = `${appData.height}px`;
                
                const isDark = appData.dark ? 'dark' : '';
                
                // Build Content based on type
                let innerContent = '';
                if(appData.type === 'special_liquid') {
                    // Special Structure for Liquid Chat
                    innerContent = `
                        <div class="liquid-container">
                            <div id="glcanvas-container"><canvas id="glcanvas"></canvas></div>
                            <div class="liquid-content-layer">
                                ${this.getTitleBarHTML(appData, 'dark')}
                                <div class="window-content dark">
                                    <div class="iframe-shield"></div>
                                    <iframe class="app-iframe" src="https://deadsimplechat.com/J4fFLy4Ek"></iframe>
                                </div>
                            </div>
                        </div>`;
                } else {
                    // Standard Window Structure
                    innerContent = this.getTitleBarHTML(appData, isDark);
                    innerContent += `<div class="window-content ${isDark}">
                                        <div class="iframe-shield"></div>
                                        ${this.getAppBodyHTML(appData)}
                                     </div>`;
                }

                win.innerHTML = innerContent;
                this.layer.appendChild(win);
                this.windows[appId] = win;

                // Attach drag listener to title bar
                const titleBar = win.querySelector('.title-bar');
                titleBar.onmousedown = (e) => this.handleDragStart(e, win);
                win.onmousedown = () => this.bringToFront(appId);

                // Initialize special apps/WebGL after insertion
                setTimeout(() => {
                    win.classList.add('active');
                    this.bringToFront(appId);
                    if(appData.type === 'special_liquid') this.initLiquidShader();
                    if(appData.type === 'custom_calc') this.initCalculator(win);
                    if(appData.type === 'custom_term') this.initTerminal(win);
                }, 10);
            }

            closeApp(appId) {
                const win = this.windows[appId];
                if(win) {
                    win.classList.remove('active');
                    win.classList.add('closing');
                    document.getElementById(`dot-${appId}`).classList.remove('active');
                    delete this.windows[appId];
                    setTimeout(() => win.remove(), 300); // Remove after animation
                    this.updateMenuBar("Finder");
                }
            }

            bringToFront(appId) {
                this.zIndexBase++;
                this.windows[appId].style.zIndex = this.zIndexBase;
                const appData = APP_REGISTRY.find(a => a && a.id === appId);
                this.updateMenuBar(appData.name);
            }

            updateMenuBar(name) {
                document.getElementById('mb-app-name').innerText = name;
            }

            // --- HTML Generators ---
            getTitleBarHTML(appData, darkClass) {
                return `
                <div class="title-bar ${darkClass}">
                    <div class="traffic-lights">
                        <div class="traffic-btn tb-close" onclick="wm.closeApp('${appData.id}')"><span class="traffic-btn-icon">√ó</span></div>
                        <div class="traffic-btn tb-min"><span class="traffic-btn-icon">‚Äì</span></div>
                        <div class="traffic-btn tb-max"><span class="traffic-btn-icon">+</span></div>
                    </div>
                    <div class="window-title-text">${appData.name}</div>
                </div>`;
            }

            getAppBodyHTML(appData) {
                switch(appData.type) {
                    case 'iframe': return `<iframe class="app-iframe" src="${appData.url}"></iframe>`;
                    case 'static': return appData.html;
                    case 'custom_calc': return this.getCalculatorHTML();
                    case 'custom_notes': return `<div class="notes-wrap"><div class="notes-sidebar">Notes</div><textarea class="notes-editor">Meeting Notes:\n- Discuss massive JS project\n- Review Tahoe designs</textarea></div>`;
                    case 'custom_term': return `<div class="terminal-wrap" id="term-output">Last login: Today on ttys000<br>macbook-pro:~ user$ <span id="term-typed"></span><span class="cursor">_</span></div>`;
                    default: return 'Error loading content';
                }
            }
            
            getCalculatorHTML() {
                return `<div class="calc-grid">
                        <div class="calc-display" id="calc-disp">0</div>
                        <button class="calc-btn top">AC</button><button class="calc-btn top">+/-</button><button class="calc-btn top">%</button><button class="calc-btn op">√∑</button>
                        <button class="calc-btn num">7</button><button class="calc-btn num">8</button><button class="calc-btn num">9</button><button class="calc-btn op">√ó</button>
                        <button class="calc-btn num">4</button><button class="calc-btn num">5</button><button class="calc-btn num">6</button><button class="calc-btn op">-</button>
                        <button class="calc-btn num">1</button><button class="calc-btn num">2</button><button class="calc-btn num">3</button><button class="calc-btn op">+</button>
                        <button class="calc-btn num zero">0</button><button class="calc-btn num">.</button><button class="calc-btn op">=</button>
                       </div>`;
            }

            // --- Drag Physics ---
            handleDragStart(e, winElement) {
                if(e.target.closest('.traffic-btn')) return; // Don't drag if clicking buttons
                this.isDragging = true;
                this.dragTarget = winElement;
                // Enable iframe shields so mouse doesn't get stuck in them
                winElement.classList.add('dragging');
                
                const rect = winElement.getBoundingClientRect();
                this.dragOffset.x = e.clientX - rect.left;
                this.dragOffset.y = e.clientY - rect.top;
                winElement.style.transition = 'none'; // Disable transitions for smooth drag
            }

            handleDragMove(e) {
                if(!this.isDragging || !this.dragTarget) return;
                const x = e.clientX - this.dragOffset.x;
                const y = e.clientY - this.dragOffset.y;
                // Simple boundary check
                const maxY = window.innerHeight - 50;
                this.dragTarget.style.left = `${x}px`;
                this.dragTarget.style.top = `${Math.min(Math.max(0, y), maxY)}px`;
            }

            handleDragEnd() {
                if(this.isDragging && this.dragTarget) {
                     this.dragTarget.classList.remove('dragging');
                     // Re-enable transitions for open/close animations
                     this.dragTarget.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
                }
                this.isDragging = false;
                this.dragTarget = null;
            }

            // --- Custom App Initializers ---
            initCalculator(win) {
                const display = win.querySelector('#calc-disp');
                let current = '0';
                win.querySelectorAll('.calc-btn').forEach(btn => {
                   btn.onclick = () => {
                       const val = btn.innerText;
                       if(val === 'AC') current = '0';
                       else if(val === '=') try { current = eval(current.replace('√ó','*').replace('√∑','/')).toString(); } catch { current = 'Error'; }
                       else if(current === '0' && !isNaN(val)) current = val;
                       else current += val;
                       display.innerText = current.substring(0, 9);
                   } 
                });
            }
            
            initTerminal(win) {
                const output = win.querySelector('#term-typed');
                let txt = "ping google.com...";
                let i = 0;
                const type = () => {
                    if (i < txt.length) { output.innerHTML += txt.charAt(i); i++; setTimeout(type, 100); }
                    else { setTimeout(() => { output.parentElement.innerHTML += "<br>PING google.com (142.250.190.78): 56 data bytes<br>64 bytes from 142.250.190.78: icmp_seq=0 ttl=116 time=14.2 ms<br>macbook-pro:~ user$ _"; }, 500); }
                };
                setTimeout(type, 800);
            }


            // --- WEBGL LIQUID SHADER ENGINE (Ported & Optimized) ---
            initLiquidShader() {
                const canvas = document.getElementById('glcanvas');
                if(!canvas) return;
                const gl = canvas.getContext('webgl');
                // Resize canvas to fit container
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
                gl.viewport(0, 0, canvas.width, canvas.height);

                const vsSource = `attribute vec2 position;void main(){gl_Position=vec4(position,0.0,1.0);}`;
                // A slightly brighter, more vibrant shader for the Tahoe vibe
                const fsSource = `precision highp float;uniform vec2 u_resolution;uniform float u_time;vec2 hash(vec2 p){p=vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));return -1.0+2.0*fract(sin(p)*43758.5453123);}float noise(in vec2 p){const float K1=0.366025404;const float K2=0.211324865;vec2 i=floor(p+(p.x+p.y)*K1);vec2 a=p-i+(i.x+i.y)*K2;float m=step(a.y,a.x);vec2 o=vec2(m,1.0-m);vec2 b=a-o+K2;vec2 c=a-1.0+2.0*K2;vec3 h=max(0.5-vec3(dot(a,a),dot(b,b),dot(c,c)),0.0);vec3 n=h*h*h*h*vec3(dot(a,hash(i+0.0)),dot(b,hash(i+o)),dot(c,hash(i+1.0)));return dot(n,vec3(70.0));}float fbm(vec2 uv){float f=0.0;uv*=2.0;f+=0.5000*noise(uv);uv=2.0*uv;f+=0.2500*noise(uv);uv=2.0*uv;f+=0.1250*noise(uv);return f;}void main(){vec2 uv=gl_FragCoord.xy/u_resolution.xy;uv.x*=u_resolution.x/u_resolution.y;vec2 p=uv*2.0;float t=u_time*0.25;float q=fbm(p-t);vec2 r=vec2(fbm(p+q+t*0.5),fbm(p-q-t*0.3));float d=fbm(p+r);float dx=fbm(p+r+vec2(0.02,0.0))-d;float dy=fbm(p+r+vec2(0.0,0.02))-d;vec3 normal=normalize(vec3(dx*8.0,dy*8.0,1.0));vec3 rainbow=0.5+0.5*cos(u_time*0.5+normal.xyx*6.0+vec3(0.0,2.0,4.0));vec3 lightDir=normalize(vec3(1.0,1.0,1.0));float specular=pow(max(dot(normal,lightDir),0.0),30.0)*1.8;gl_FragColor=vec4(rainbow*0.9+vec3(specular),1.0);}`;

                const compileShader = (type, source) => { const s = gl.createShader(type); gl.shaderSource(s, source); gl.compileShader(s); return s; };
                const program = gl.createProgram();
                gl.attachShader(program, compileShader(gl.VERTEX_SHADER, vsSource));
                gl.attachShader(program, compileShader(gl.FRAGMENT_SHADER, fsSource));
                gl.linkProgram(program); gl.useProgram(program);
                const vertices = new Float32Array([-1,-1,1,-1,-1,1,1,1]);
                gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer()); gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
                const position = gl.getAttribLocation(program, "position"); gl.enableVertexAttribArray(position); gl.vertexAttribPointer(position, 2, gl.FLOAT, false, 0, 0);
                const timeLoc = gl.getUniformLocation(program, "u_time"); const resLoc = gl.getUniformLocation(program, "u_resolution");
                let startTime = Date.now();
                const render = () => { gl.uniform2f(resLoc, canvas.width, canvas.height); gl.uniform1f(timeLoc, (Date.now()-startTime)/1000.0); gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4); requestAnimationFrame(render); };
                render();
            }
        }

        // Initialize the Operating System
        const wm = new WindowManager();

    </script>
</body>
</html>
