<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ice Age Board Game - Classic Edition</title>
    <style>
        /* CORE GITHUB RESIZING - NO SCROLLBARS */
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
            font-family: Arial, sans-serif; background: #0d1321; color: #FFF;
            position: absolute; inset: 0; box-sizing: border-box; user-select: none;
        }

        * { box-sizing: inherit; }

        /* BASIC LAYOUT */
        #game-container {
            display: flex; width: 100%; height: 100%; padding: 10px; gap: 10px;
        }

        /* MOBILE VS DESKTOP SPLIT */
        @media (min-aspect-ratio: 1/1) { /* Desktop */
            #game-container { flex-direction: row; }
            #left-col { flex: 1; display: flex; align-items: center; justify-content: center; }
            #right-col { width: 400px; display: flex; flex-direction: column; gap: 10px; }
        }
        @media (max-aspect-ratio: 1/1) { /* Mobile */
            #game-container { flex-direction: column; }
            #left-col { flex: 0 0 55%; display: flex; align-items: center; justify-content: center; }
            #right-col { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        }

        /* THE BOARD */
        #board-wrapper {
            position: relative; width: 100%; height: 100%; max-width: 100vh; max-height: 100vw; aspect-ratio: 1/1;
        }
        #board {
            display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr);
            gap: 2px; width: 100%; height: 100%; background: #222; border: 2px solid #555; padding: 4px;
        }

        .space {
            background: #FFF; border: 1px solid #000; color: #000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; font-size: clamp(0.6rem, 2vmin, 1rem);
            font-weight: bold; position: relative;
        }
        .s-start { background: #FFC107; }
        .s-jaap { background: #FF1744; color: #FFF; }
        .s-event { color: #FF1744; font-size: clamp(1rem, 3vmin, 1.5rem); }

        .token-container {
            position: absolute; bottom: 2px; display: flex; flex-wrap: wrap; justify-content: center; width: 100%; gap: 2px;
        }
        .token {
            width: clamp(15px, 3.5vmin, 25px); height: clamp(15px, 3.5vmin, 25px); border-radius: 50%;
            border: 2px solid #FFF; color: #FFF; font-weight: bold; display: flex; align-items: center; justify-content: center;
            font-size: clamp(0.7rem, 2vmin, 1rem); z-index: 10;
        }

        /* UI ELEMENTS */
        .panel { background: #1a2332; border: 1px solid #333; border-radius: 8px; padding: 10px; }
        #hud { display: flex; flex-wrap: wrap; gap: 5px; height: 40%; overflow-y: auto; }
        .player-card { flex: 1; min-width: 45%; background: #000; border-top: 5px solid; padding: 10px; text-align: center; border-radius: 5px; }
        .player-card.active { border: 2px solid #FFC107; border-top: 5px solid #FFC107; background: #332a00; }
        
        #controls { height: 60%; display: flex; flex-direction: column; align-items: center; }
        #log { flex: 1; width: 100%; background: #000; color: #00E676; font-family: monospace; overflow-y: auto; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 14px;}
        .log-entry { margin-bottom: 5px; border-bottom: 1px dotted #333; padding-bottom: 5px; }

        .btn {
            background: #FFC107; border: none; padding: 15px; font-size: 20px; font-weight: bold;
            border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 10px; text-transform: uppercase;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #555; cursor: not-allowed; color: #888; }

        /* BULLETPROOF MODAL */
        #simple-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 20px;
        }
        .modal-content {
            background: #222; border: 3px solid #00E5FF; padding: 30px; text-align: center; border-radius: 10px; max-width: 500px; width: 100%;
        }
        .modal-content h2 { color: #FFC107; margin-top: 0; }
        .modal-content p { font-size: 18px; margin-bottom: 20px; }
        #modal-btn-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="left-col">
            <div id="board-wrapper">
                <div id="board">
                    </div>
            </div>
        </div>

        <div id="right-col">
            <div id="hud" class="panel">
                </div>
            
            <div id="controls" class="panel">
                <h2 id="turn-indicator" style="margin: 0 0 10px 0; text-align: center;">Game Start</h2>
                <div id="dice-display" style="font-size: 40px; margin-bottom: 10px;">ðŸŽ²</div>
                <button id="btn-roll" class="btn">ROLL DICE</button>
                <div id="log"></div>
            </div>
        </div>
    </div>

    <div id="simple-modal">
        <div class="modal-content">
            <h2 id="sm-title">Title</h2>
            <p id="sm-text">Description</p>
            <div id="modal-btn-container">
                </div>
        </div>
    </div>

<script>
    /* =========================================================================
       1. GAME DATA & RULES
       ========================================================================= */
    const gridMap = [
        {c:1, r:1}, {c:2, r:1}, {c:3, r:1}, {c:4, r:1}, {c:5, r:1}, {c:6, r:1}, {c:7, r:1}, {c:8, r:1}, {c:9, r:1}, {c:10, r:1}, 
        {c:10, r:2}, {c:10, r:3}, {c:10, r:4}, {c:10, r:5}, {c:10, r:6}, {c:10, r:7}, {c:10, r:8}, {c:10, r:9}, 
        {c:10, r:10}, {c:9, r:10}, {c:8, r:10}, {c:7, r:10}, {c:6, r:10}, {c:5, r:10}, {c:4, r:10}, {c:3, r:10}, {c:2, r:10}, {c:1, r:10}, 
        {c:1, r:9}, {c:1, r:8}, {c:1, r:7}, {c:1, r:6}, {c:1, r:5}, {c:1, r:4}, {c:1, r:3}, {c:1, r:2} 
    ];

    const Events = [
        "Glacier Collapse! Everyone loses 1 ðŸŒ°.",
        "Golden Find! Collect 2 ðŸŒ°.",
        "Avalanche! Move back 3 spaces.",
        "Ice Slide! Move forward to a Free Space."
    ];

    // The Space Logic: Keep it simple. It either runs an action or does nothing.
    const SpaceData = [
        { t: "START", class: "s-start" }, 
        { t: "+1 ðŸŒ°", action: (p) => gainAcorns(p, 1) }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) },
        { t: "Go Start", action: (p) => teleport(p, 0) }, 
        { t: "+1 Roll", action: (p) => { showMsg("EXTRA ROLL", "You get to roll again!", () => rollDice(p)); return true; /* true means don't pass turn */ } }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) }, 
        { t: "+3 Spaces", action: (p) => moveToken(p, 3) }, 
        { t: "Jaap STOP", class: "s-jaap", action: (p) => { p.skip = true; showMsg("JAAP STOP", "Vehicle broken. Skip next turn.", passTurn); return true; } }, 
        { t: "Free space" }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) }, 
        { t: "Jaap (+2ðŸŒ°)", action: (p) => { gainAcorns(p, 2); jumpTo(p, "Jaap STOP"); return true; } }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) }, 
        { t: "Jaap STOP", class: "s-jaap", action: (p) => { p.skip = true; showMsg("JAAP STOP", "Vehicle broken. Skip next turn.", passTurn); return true; } }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) }, 
        { t: "+1 ðŸŒ°", action: (p) => gainAcorns(p, 1) }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) }, 
        { t: "Jaap STOP", class: "s-jaap", action: (p) => { p.skip = true; showMsg("JAAP STOP", "Vehicle broken. Skip next turn.", passTurn); return true; } }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) }, 
        { t: "Free space" }, 
        { t: "Bridge" }, 
        { t: "Free space" },
        { t: "-4 Spaces", action: (p) => moveToken(p, -4) }, 
        { t: "-2 ðŸŒ°", action: (p) => loseAcorns(p, 2) }, 
        { t: "Jaap STOP", class: "s-jaap", action: (p) => { p.skip = true; showMsg("JAAP STOP", "Vehicle broken. Skip next turn.", passTurn); return true; } }, 
        { t: "-8 Spaces", action: (p) => moveToken(p, -8) }, 
        { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) },
        { t: "+1 ðŸŒ°", action: (p) => gainAcorns(p, 1) }, 
        { t: "End", class: "s-jaap" },
        // Pad out the rest to 36 spaces to complete the square board
        { t: "Free space" }, { t: "+1 ðŸŒ°", action: (p) => gainAcorns(p, 1) }, { t: "EVENT", class: "s-event", action: (p) => triggerEvent(p) },
        { t: "Jaap STOP", class: "s-jaap", action: (p) => { p.skip = true; showMsg("JAAP STOP", "Vehicle broken. Skip next turn.", passTurn); return true; } },
        { t: "Free space" }, { t: "Bridge" }, { t: "Free space" }, { t: "+2 ðŸŒ°", action: (p) => gainAcorns(p, 2) }
    ];

    /* =========================================================================
       2. STATE & SETUP
       ========================================================================= */
    const colors = ['#F44336', '#4CAF50', '#2196F3', '#FFEB3B'];
    let state = {
        players: [
            { id: 0, name: "Player 1", color: colors[0], pos: 0, acorns: 4, laps: 0, skip: false },
            { id: 1, name: "Player 2", color: colors[1], pos: 0, acorns: 4, laps: 0, skip: false },
            { id: 2, name: "Player 3", color: colors[2], pos: 0, acorns: 4, laps: 0, skip: false },
            { id: 3, name: "Player 4", color: colors[3], pos: 0, acorns: 4, laps: 0, skip: false }
        ],
        turn: 0
    };

    function initGame() {
        const board = document.getElementById('board');
        for (let i = 0; i < 36; i++) {
            let sp = SpaceData[i] || { t: "Free space" }; // Fallback
            let div = document.createElement('div');
            div.className = `space ${sp.class || ''}`;
            div.id = `space-${i}`;
            div.style.gridColumn = gridMap[i].c;
            div.style.gridRow = gridMap[i].r;
            div.innerHTML = `<span>${sp.t}</span><div id="tc-${i}" class="token-container"></div>`;
            board.appendChild(div);
        }
        
        state.players.forEach(p => drawToken(p));
        updateHUD();
        startTurn();
    }

    /* =========================================================================
       3. CORE LOGIC
       ========================================================================= */
    function drawToken(p) {
        let old = document.getElementById(`tok-${p.id}`);
        if (old) old.remove();
        let tok = document.createElement('div');
        tok.id = `tok-${p.id}`;
        tok.className = 'token';
        tok.style.background = p.color;
        tok.innerText = p.name.charAt(0);
        document.getElementById(`tc-${p.pos}`).appendChild(tok);
    }

    function updateHUD() {
        const hud = document.getElementById('hud');
        hud.innerHTML = '';
        state.players.forEach((p, i) => {
            hud.innerHTML += `
                <div class="player-card ${i === state.turn ? 'active' : ''}" style="border-top-color:${p.color};">
                    <div style="color:${p.color}; font-weight:bold;">${p.name}</div>
                    <div style="font-size: 24px; color: #FFC107; margin: 5px 0;">${p.acorns} ðŸŒ°</div>
                    <div>Laps: ${p.laps}/3</div>
                </div>`;
        });
    }

    function log(msg) {
        const l = document.getElementById('log');
        l.innerHTML = `<div class="log-entry">${msg}</div>` + l.innerHTML;
    }

    // A foolproof modal to pause the game safely
    function showMsg(title, text, callback) {
        document.getElementById('simple-modal').style.display = 'flex';
        document.getElementById('sm-title').innerText = title;
        document.getElementById('sm-text').innerText = text;
        
        let btnContainer = document.getElementById('modal-btn-container');
        btnContainer.innerHTML = `<button class="btn" id="modal-ok-btn" style="width: auto; padding: 10px 30px;">OK</button>`;
        
        document.getElementById('modal-ok-btn').onclick = () => {
            document.getElementById('simple-modal').style.display = 'none';
            if (callback) callback();
        };
    }

    /* =========================================================================
       4. TURN ENGINE
       ========================================================================= */
    function startTurn() {
        let p = state.players[state.turn];
        document.getElementById('turn-indicator').innerText = `${p.name}'s Turn`;
        document.getElementById('turn-indicator').style.color = p.color;
        
        if (p.skip) {
            p.skip = false;
            document.getElementById('btn-roll').disabled = true;
            log(`ðŸ›‘ ${p.name} loses their turn (Vehicle Broken).`);
            showMsg("Turn Skipped", `${p.name}, your vehicle is broken. You lose this turn.`, passTurn);
            return;
        }
        
        document.getElementById('btn-roll').disabled = false;
    }

    document.getElementById('btn-roll').addEventListener('click', () => {
        let p = state.players[state.turn];
        document.getElementById('btn-roll').disabled = true; // Prevent double click
        rollDice(p);
    });

    function rollDice(p) {
        let roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-display').innerText = `ðŸŽ² ${roll}`;
        log(`ðŸŽ² ${p.name} rolled a ${roll}.`);
        moveToken(p, roll);
    }

    function moveToken(p, spaces) {
        let oldPos = p.pos;
        p.pos += spaces;

        // Lap logic
        if (p.pos >= 36) {
            p.pos = p.pos - 36;
            p.laps++;
            p.acorns += 2;
            log(`ðŸ ${p.name} completed a lap! (+2 ðŸŒ°)`);
            if(p.laps >= 3) {
                showMsg("WINNER!", `${p.name} finished 3 laps and wins the game!`, () => location.reload());
                return;
            }
        } else if (p.pos < 0) {
            p.pos = 36 + p.pos; // Move backwards wrap around
        }

        drawToken(p);
        evaluateSpace(p);
    }

    function teleport(p, spaceIndex) {
        p.pos = spaceIndex;
        drawToken(p);
        evaluateSpace(p);
    }

    function jumpTo(p, spaceName) {
        let target = -1;
        for(let i=1; i<36; i++) {
            let checkPos = (p.pos + i) % 36;
            let sp = SpaceData[checkPos] || {t:""};
            if(sp.t.toLowerCase().includes(spaceName.toLowerCase())) { target = checkPos; break; }
        }
        if(target !== -1) teleport(p, target);
        else passTurn();
    }

    /* =========================================================================
       5. SPACE ACTIONS
       ========================================================================= */
    function evaluateSpace(p) {
        let sp = SpaceData[p.pos] || { t: "Free space" };
        log(`ðŸ“ ${p.name} landed on: ${sp.t}`);
        updateHUD();

        // If the space has an action, run it. 
        if (sp.action) {
            let dontPassTurn = sp.action(p); 
            // If the action handles passing the turn itself (like opening a modal), it returns true.
            // Otherwise, we pass the turn automatically.
            if (!dontPassTurn) {
                setTimeout(passTurn, 800);
            }
        } else {
            // Boring space. Just pass the turn after a brief pause so they see they landed.
            setTimeout(passTurn, 800);
        }
    }

    function gainAcorns(p, amt) {
        p.acorns += amt;
        log(`ðŸ’° ${p.name} got ${amt} ðŸŒ°.`);
        updateHUD();
    }

    function loseAcorns(p, amt) {
        if(p.acorns < amt) amt = p.acorns;
        p.acorns -= amt;
        log(`ðŸ”» ${p.name} lost ${amt} ðŸŒ°.`);
        updateHUD();
    }

    function triggerEvent(p) {
        let evText = Events[Math.floor(Math.random() * Events.length)];
        log(`ðŸ“œ Event: ${evText}`);
        
        // Execute simple logic based on text to keep it foolproof
        showMsg("EVENT DRAWN", evText, () => {
            if (evText.includes("Everyone loses")) {
                state.players.forEach(pl => { if(pl.acorns > 0) pl.acorns--; });
            } else if (evText.includes("Collect 2")) {
                p.acorns += 2;
            } else if (evText.includes("Move back 3")) {
                moveToken(p, -3); return; // moveToken calls evaluateSpace which handles passing turn
            } else if (evText.includes("Free Space")) {
                jumpTo(p, "Free space"); return; // jumpTo handles passing turn
            }
            updateHUD();
            passTurn();
        });
        return true; // Tells evaluateSpace that we are handling the turn pass
    }

    function passTurn() {
        state.turn = (state.turn + 1) % state.players.length;
        updateHUD();
        startTurn();
    }

    // Start everything
    window.onload = initGame;

</script>
</body>
</html>
