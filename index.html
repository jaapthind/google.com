<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ice Age: The Final Masterpiece</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå∞</text></svg>">
    
    <style>
        /* ==========================================================================
           1. CORE ENGINE & LIQUID RAINBOW (60FPS Optimized)
           ========================================================================== */
        :root {
            --glass: rgba(15, 20, 30, 0.75);
            --border: rgba(255, 255, 255, 0.2);
            --cyan: #00E5FF;
            --gold: #FFC107;
            --red: #FF1744;
            --green: #00E676;
        }
        /* INSTRUCTIONS BUTTONS & PANEL */
        .btn-info { background: #607D8B; box-shadow: 0 4px 0 #37474F; color: #FFF; font-size: 0.9rem; padding: 10px; margin-top: 5px; }
        .instr-grid { text-align: left; display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 50vh; overflow-y: auto; padding: 10px; }
        .instr-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border-left: 4px solid var(--cyan); font-size: 0.95rem; line-height: 1.4; }
        .instr-item b { color: var(--gold); }
        #sm-body { max-height: 60vh; overflow-y: auto; }
        html, body {

            
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradient 15s ease infinite;
            color: white; position: absolute; inset: 0; box-sizing: border-box; user-select: none;
        }

        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        * { box-sizing: border-box; outline: none; }

        .glass { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.5); }

        /* ==========================================================================
           2. WEATHER & FX LAYER
           ========================================================================== */
        #fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 100; opacity: 0; transition: opacity 2s; }
        .weather-snow { background-image: radial-gradient(circle, #FFF 2px, transparent 3px); background-size: 80px 80px; animation: snowMove 5s linear infinite; }
        .weather-rain { background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.2)); background-size: 2px 50px; animation: rainMove 0.3s linear infinite; }
        @keyframes snowMove { from { background-position: 0 0; } to { background-position: 100px 500px; } }
        @keyframes rainMove { from { background-position: 0 0; } to { background-position: 0 500px; } }

        /* ==========================================================================
           3. SETUP & PROFANITY UI
           ========================================================================== */
        #setup-screen { position: absolute; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); }
        .setup-card { padding: 40px; border-radius: 20px; width: 90%; max-width: 650px; text-align: center; border: 2px solid var(--cyan); }
        .setup-card h1 { font-size: 3.5rem; margin: 0; font-weight: 900; color: var(--gold); text-shadow: 0 0 20px rgba(255,193,7,0.5); }
        
        .setup-row { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.4); padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--border); gap: 15px; }
        .setup-row select, .setup-row input { background: #111; color: white; border: 1px solid var(--cyan); padding: 10px; border-radius: 6px; font-weight: bold; font-size: 1rem; }
        .setup-row input { flex: 1; }
        
        #error-msg { background: var(--red); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; font-weight: bold; font-size: 0.9rem; }

        /* ==========================================================================
           4. GAME LAYOUT & PROCEDURAL BOARD
           ========================================================================== */
        #game-container { display: none; width: 100%; height: 100%; padding: 1.5vmin; gap: 1.5vmin; }
        #left-col { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        #right-col { width: 420px; display: flex; flex-direction: column; gap: 1.5vmin; z-index: 10; }

        #board-wrapper { position: relative; width: 100%; height: 100%; max-width: 92vh; max-height: 92vw; aspect-ratio: 1/1; }
        #board { display: grid; width: 100%; height: 100%; border-radius: 15px; position: relative; gap: 3px; padding: 5px; }

        #center-island { grid-column: 2 / -2; grid-row: 2 / -2; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; border-radius: 10px; overflow: hidden; z-index: 1; border: 2px solid var(--border); }
        .biome { background-size: cover; background-position: center; position: relative; }
        .biome::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.2); }
        .b-grass { background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=600'); }
        .b-peaks { background-image: url('https://images.unsplash.com/photo-1517823382935-51bfcb0ec6bc?w=600'); }
        .b-village { background-image: url('https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=600'); }
        .b-tundra { background-image: url('https://images.unsplash.com/photo-1478265409131-1f65c88f965c?w=600'); }

        .space { background: rgba(255, 255, 255, 0.95); border: 1px solid #000; color: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 0.65rem; font-weight: 900; position: relative; border-radius: 5px; z-index: 10; transition: transform 0.2s; text-transform: uppercase; }
        .s-start { background: var(--gold) !important; color: #000; font-size: 0.8rem; }
        .s-event { color: var(--red); font-size: 0.9rem; }
        .s-jaap { background: var(--red) !important; color: #FFF; border-radius: 50%; }
        .s-market { background: #D500F9 !important; color: #FFF; }
        .s-cave { background: var(--cyan) !important; color: #000; }
        .s-jackpot { background: var(--green) !important; color: #000; }
        .s-team { background: #FF9800 !important; color: #FFF; border: 2px solid #FFF; }
        .s-secret { background: #607D8B !important; color: #FFF; }

        .token-container { position: absolute; bottom: 2px; display: flex; flex-wrap: wrap; justify-content: center; width: 100%; z-index: 50; pointer-events: none; }
        .token { width: clamp(22px, 4vmin, 35px); height: clamp(22px, 4vmin, 35px); border-radius: 50%; border: 3px solid #FFF; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* ==========================================================================
           5. UI PANELS
           ========================================================================== */
        #hud { display: flex; flex-direction: column; gap: 10px; height: 45%; overflow-y: auto; padding-right: 5px; }
        .player-card { padding: 12px; border-radius: 12px; border-left: 6px solid; transition: 0.3s; background: rgba(0,0,0,0.3); }
        .player-card.active { background: rgba(255,255,255,0.15); border-left-width: 12px; transform: translateX(5px); }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-top: 5px; background: #000; }

        #controls { height: 55%; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        #log { flex: 1; width: 100%; background: rgba(0,0,0,0.7); border-radius: 12px; margin-top: 10px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.85rem; overflow-y: auto; border: 1px solid var(--border); }
        .log-entry { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 3px 0; color: #CCC; }
        .log-entry b { color: var(--cyan); }

        .btn { background: var(--gold); border: none; padding: 15px; font-size: 1.5rem; font-weight: 900; border-radius: 12px; cursor: pointer; width: 100%; color: #000; transition: 0.2s; box-shadow: 0 4px 0 #b38600; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #b38600; }
        .btn:disabled { background: #555; box-shadow: none; transform: none; color: #888; cursor: not-allowed; }
        .btn-cyan { background: var(--cyan); box-shadow: 0 4px 0 #00acc1; }

        /* ==========================================================================
           6. MODALS & DICE
           ========================================================================== */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 5000; }
        .modal-content { width: 90%; max-width: 550px; padding: 30px; border-radius: 20px; text-align: center; border: 2px solid var(--cyan); }
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .market-item { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid var(--border); transition: 0.2s; }
        .market-item:hover { border-color: var(--gold); background: rgba(255,255,255,0.1); }

        #dice-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 4000; }
        .dice-box { width: 120px; height: 120px; background: #FFF; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 70px; color: #000; animation: shake 0.4s infinite; border: 5px solid #000; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 75% { transform: rotate(-10deg); } }

        .float-text { position: absolute; font-weight: 900; font-size: 2rem; pointer-events: none; z-index: 500; animation: floatUp 1s forwards; text-shadow: 2px 2px #000; }
        @keyframes floatUp { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-100px) scale(1.5); } }
    </style>
</head>
<body>

    <div id="fx-layer"></div>
    <div id="dice-overlay"><div class="dice-box" id="dice-face">üé≤</div></div>

    <div id="setup-screen">
        <div class="setup-card glass">
            <h1>ICE AGE: FINALE</h1>
            <div id="error-msg"></div>
            
            <div class="setup-row">
                <span>BOARD CONFIGURATION:</span>
                <select id="board-size">
                    <option value="20">Sprinting (20 Spaces)</option>
                    <option value="36" selected>Classic (36 Spaces)</option>
                    <option value="60">Marathon (60 Spaces)</option>
                </select>
            </div>

            <div class="setup-row">
                <span>PLAYER COUNT:</span>
                <select id="player-count">
                    <option value="2">2 Players</option>
                    <option value="3">3 Players</option>
                    <option value="4" selected>4 Players</option>
                </select>
            </div>
            
            <div id="player-inputs"></div>
            <button id="btn-start" class="btn btn-cyan" style="margin-top: 20px;">INITIALIZE GAME</button>
            <button class="btn btn-info" onclick="showInstructions()">GAME INSTRUCTIONS</button>
        </div>
    </div>

    <div id="game-container">
        <div id="left-col">
            <div id="board-wrapper">
                <div id="board" class="glass">
                    <div id="center-island">
                        <div class="biome b-grass"></div>
                        <div class="biome b-peaks"></div>
                        <div class="biome b-village"></div>
                        <div class="biome b-tundra"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="right-col">
            <div id="hud" class="panel glass"></div>
            <div id="controls" class="panel glass">
                <div id="turn-indicator" style="font-size: 2rem; font-weight: 900; text-transform: uppercase;"></div>
                <div style="margin: 5px 0; font-weight: bold; color: var(--gold);">
                    TURN: <span id="turn-counter">1</span> | JACKPOT: <span id="jackpot-counter">0</span> üå∞
                </div>
                <button id="btn-roll" class="btn">ROLL DICE üé≤</button>
                <button class="btn btn-info" onclick="showInstructions()">HOW TO PLAY</button>
                <div id="log"></div>
            </div>
        </div>
    </div>

    <div id="simple-modal" class="modal-overlay">
        <div class="modal-content glass">
            <h2 id="sm-title" style="color: var(--gold);"></h2>
            <p id="sm-text" style="font-size: 1.2rem;"></p>
            <div id="modal-btn-container"></div>
        </div>
    </div>

    <div id="market-modal" class="modal-overlay">
        <div class="modal-content glass" style="max-width: 700px;">
            <h2 style="color: var(--cyan); font-size: 2.5rem;">VILLAGE OUTPOST</h2>
            <p id="market-wallet" style="font-weight: bold; color: var(--gold);"></p>
            <div class="market-grid" id="market-items"></div>
            <button class="btn" style="background: #444; color: #FFF; box-shadow: none;" onclick="closeMarket()">EXIT STORE</button>
        </div>
    </div>

<script>
    /* =========================================================================
       1. MILITARY-GRADE ENGINE CONFIG
       ========================================================================= */
    const colors = ['#F44336', '#4CAF50', '#2196F3', '#FFEB3B'];
    const emojis = ['ü¶ñ', 'ü¶£', 'üêß', 'üê∫', 'üßä', 'üèîÔ∏è', 'üèπ', 'üêª‚Äç‚ùÑÔ∏è'];
    const severeWords = ['fuck', 'shit', 'bitch', 'nigg', 'cunt', 'whore', 'slut', 'fag', 'dick', 'pussy', 'cock', 'blowjob', 'dildo', 'masturbat', 'rape', 'incest', 'bollock', 'smegma', 'tosser'];
    const exactWords = ['anal', 'anus', 'arse', 'ass', 'ballsack', 'balls', 'bastard', 'boob', 'bugger', 'bum', 'butt', 'buttplug', 'clitoris', 'crap', 'cum', 'damn', 'dyke', 'feck', 'fellate', 'fellatio', 'felching', 'flange', 'hell', 'homo', 'jerk', 'jizz', 'knob', 'labia', 'lmao', 'lmfao', 'muff', 'omg', 'penis', 'piss', 'poop', 'prick', 'pube', 'queer', 'scrotum', 'sex', 'spunk', 'tit', 'turd', 'twat', 'vagina', 'wank', 'wtf'];

    let state = {
        players: [],
        turn: 0,
        totalTurns: 1,
        jackpot: 0,
        boardSize: 36,
        gridSide: 10,
        spaceActions: [],
        isAnimating: false
    };

    function isClean(name) {
        let n = name.toLowerCase();
        for (let w of exactWords) { if (new RegExp(`\\b${w}\\b`, 'i').test(n)) return false; }
        let s = n.replace(/[^a-z0-9]/gi, '').replace(/1/g, 'i').replace(/0/g, 'o').replace(/3/g, 'e').replace(/5/g, 's').replace(/4/g, 'a').replace(/7/g, 't');
        for (let w of severeWords) { if (s.includes(w)) return false; }
        return true;
    }

    /* =========================================================================
       2. SETUP LOGIC
       ========================================================================= */
    const countSelect = document.getElementById('player-count');
    const inputs = document.getElementById('player-inputs');

    function renderSetup() {
        inputs.innerHTML = '';
        let count = parseInt(countSelect.value);
        for (let i = 0; i < count; i++) {
            inputs.innerHTML += `
                <div class="setup-row">
                    <div style="width:20px; height:20px; border-radius:50%; background:${colors[i]}"></div>
                    <input type="text" id="p${i}-name" placeholder="Name" value="Player ${i+1}" maxlength="10">
                    <select id="p${i}-emoji">${emojis.map(e => `<option>${e}</option>`).join('')}</select>
                </div>`;
        }
    }
    countSelect.addEventListener('change', renderSetup);
    renderSetup();

    document.getElementById('btn-start').addEventListener('click', () => {
        let count = parseInt(countSelect.value);
        state.boardSize = parseInt(document.getElementById('board-size').value);
        state.gridSide = (state.boardSize / 4) + 1;
        
        let err = document.getElementById('error-msg');
        err.style.display = 'none';

        for (let i = 0; i < count; i++) {
            let n = document.getElementById(`p${i}-name`).value.trim();
            if (!n || !isClean(n)) { err.innerText = "NAME REJECTED: Profanity or empty."; err.style.display = "block"; return; }
            state.players.push({
                id: i, name: n, color: colors[i], emoji: document.getElementById(`p${i}-emoji`).value,
                pos: 0, acorns: 4, laps: 0, skip: false, ally: null, upgrades: [], team: null
            });
        }
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        initProceduralBoard();
    });

    /* =========================================================================
       3. BOARD GENERATION & ANIMATION QUEUE
       ========================================================================= */
    function initProceduralBoard() {
        const board = document.getElementById('board');
        board.style.gridTemplateColumns = `repeat(${state.gridSide}, 1fr)`;
        board.style.gridTemplateRows = `repeat(${state.gridSide}, 1fr)`;

        let perimeter = [];
        let c=1, r=1;
        for(c=1; c<=state.gridSide; c++) perimeter.push({c,r});
        c=state.gridSide; for(r=2; r<=state.gridSide; r++) perimeter.push({c,r});
        r=state.gridSide; for(c=state.gridSide-1; c>=1; c--) perimeter.push({c,r});
        c=1; for(r=state.gridSide-1; r>=2; r--) perimeter.push({c,r});

        const types = ["+1 üå∞", "+2 üå∞", "EVENT", "EVENT", "Market", "Ice Cave", "Jaap STOP", "JACKPOT", "Bear Trap", "TEAM PACT", "Secret Path", "Toll Bridge"];
        
        perimeter.forEach((pos, i) => {
            let type = (i === 0) ? "START" : types[Math.floor(Math.random() * types.length)];
            let div = document.createElement('div');
            div.className = `space s-${type.toLowerCase().replace(/ /g, '')}`;
            div.style.gridColumn = pos.c; div.style.gridRow = pos.r;
            div.innerHTML = `<span>${type}</span><div id="tc-${i}" class="token-container"></div>`;
            board.appendChild(div);
            state.spaceActions[i] = type;
        });

        state.players.forEach(p => drawToken(p));
        updateHUD();
        startTurn();
    }

    /* =========================================================================
       4. MOVEMENT & COLLISION ENGINE (THE FIX)
       ========================================================================= */
    function drawToken(p) {
        let old = document.getElementById(`tok-${p.id}`); if (old) old.remove();
        let tok = document.createElement('div');
        tok.className = 'token'; tok.id = `tok-${p.id}`;
        tok.style.background = p.color; tok.innerText = p.emoji;
        document.getElementById(`tc-${p.pos}`).appendChild(tok);
    }

    function moveStep(p, amtRemaining, evaluateAtEnd) {
        if (amtRemaining === 0) {
            state.isAnimating = false;
            if (evaluateAtEnd) handleLanding(p);
            else passTurn();
            return;
        }

        let direction = amtRemaining > 0 ? 1 : -1;
        
        // Snow Tires Upgrade: Block backward movement
        if (direction === -1 && p.upgrades.includes("Snow Tires")) {
            log(`<b>${p.name}</b> used Snow Tires to stop a slide!`);
            handleLanding(p);
            return;
        }

        p.pos += direction;

        // LAP LOGIC & EXPLOIT FIX
        if (p.pos >= state.boardSize) {
            p.pos = 0; p.laps++;
            if (p.laps > 0) { 
                gainAcorns(p, 2); log(`<b>${p.name}</b> Lap Complete! +2 üå∞`);
                if (p.laps >= 3) { triggerWin(p); return; }
            }
        } else if (p.pos < 0) {
            p.pos = state.boardSize - 1; p.laps--;
            log(`<b>${p.name}</b> fell back behind Start!`);
        }

        drawToken(p);
        updateHUD();
        
        setTimeout(() => {
            moveStep(p, amtRemaining > 0 ? amtRemaining - 1 : amtRemaining + 1, evaluateAtEnd);
        }, 200);
    }

    function handleLanding(p) {
        // Duel Check
        let enemy = state.players.find(o => o.id !== p.id && o.pos === p.pos);
        if (enemy) {
            triggerDuel(p, enemy, () => evaluateSpace(p));
        } else {
            evaluateSpace(p);
        }
    }

    /* =========================================================================
       5. SPACE EVALUATION (NO-FREEZE LOGIC)
       ========================================================================= */
    function evaluateSpace(p) {
        let type = state.spaceActions[p.pos];
        log(`<b>${p.name}</b> landed on <b>${type}</b>`);

        switch(type) {
            case "+1 üå∞": gainAcorns(p, 1); passTurn(); break;
            case "+2 üå∞": gainAcorns(p, 2); passTurn(); break;
            case "Market": openMarket(p); break;
            case "JACKPOT": claimJackpot(p); break;
            case "Jaap STOP": case "Bear Trap": 
                p.skip = true; 
                if (type === "Bear Trap") loseAcorns(p, 1, true);
                showMsg(type, "You are frozen for 1 turn!", passTurn);
                break;
            case "Ice Cave": 
                let target = Math.floor(Math.random() * state.boardSize);
                showMsg("ICE CAVE", "Warping to a random location!", () => teleportToken(p, target));
                break;
            case "TEAM PACT":
                if (p.team) passTurn();
                else {
                    let partner = state.players.filter(o => o.id !== p.id && !o.team).sort((a,b) => a.acorns - b.acorns)[0];
                    if (partner) {
                        p.team = "A"; partner.team = "A";
                        showMsg("TEAM PACT", `Linked with ${partner.name}! Share the victory!`, passTurn);
                    } else passTurn();
                }
                break;
            case "Secret Path":
                if (p.acorns >= 4) {
                    showChoice("SECRET PATH", "Pay 4 üå∞ to warp 9 spaces ahead?", [
                        {text: "PAY & WARP", action: () => { loseAcorns(p, 4, false); teleportToken(p, (p.pos + 9) % state.boardSize); }},
                        {text: "SKIP", action: passTurn}
                    ]);
                } else {
                    showMsg("PATH LOCKED", "You need 4 üå∞ for this shortcut!", passTurn);
                }
                break;
            case "Toll Bridge":
                showMsg("TOLL BRIDGE", "Lose 1 üå∞ to cross.", () => { loseAcorns(p, 1, true); passTurn(); });
                break;
            case "EVENT":
                triggerEvent(p);
                break;
            default: passTurn();
        }
    }

    /* =========================================================================
       6. CORE GAME UTILITIES
       ========================================================================= */
    function teleportToken(p, target) {
        let tok = document.getElementById(`tok-${p.id}`);
        tok.style.opacity = '0';
        setTimeout(() => {
            p.pos = target;
            drawToken(p);
            let newTok = document.getElementById(`tok-${p.id}`);
            newTok.style.opacity = '0';
            setTimeout(() => {
                newTok.style.opacity = '1';
                handleLanding(p);
            }, 100);
        }, 400);
    }

    function gainAcorns(p, amt) { p.acorns += amt; showFloat(p, `+${amt}`, 'var(--green)'); updateHUD(); }
    function loseAcorns(p, amt, toJackpot) {
        let loss = Math.min(p.acorns, amt);
        p.acorns -= loss;
        if (toJackpot) state.jackpot += loss;
        showFloat(p, `-${loss}`, 'var(--red)');
        updateHUD();
    }

    function openMarket(p) {
        document.getElementById('market-wallet').innerText = `WALLET: ${p.acorns} üå∞`;
        let grid = document.getElementById('market-items');
        grid.innerHTML = `
            <div class="market-item"><h4>MAMMOTH</h4><p>Immune to Jaap Stops</p><b>3 üå∞</b><br><button class="btn btn-cyan" onclick="buyItem('Mammoth', 3)">BUY</button></div>
            <div class="market-item"><h4>TURBO ENGINE</h4><p>+2 to every Roll</p><b>5 üå∞</b><br><button class="btn btn-cyan" onclick="buyItem('Turbo Engine', 5)">BUY</button></div>
            <div class="market-item"><h4>SNOW TIRES</h4><p>Immune to backwards slides</p><b>4 üå∞</b><br><button class="btn btn-cyan" onclick="buyItem('Snow Tires', 4)">BUY</button></div>
            <div class="market-item"><h4>CAVEMAN</h4><p>+1 to every Roll</p><b>3 üå∞</b><br><button class="btn btn-cyan" onclick="buyItem('Caveman', 3)">BUY</button></div>
        `;
        document.getElementById('market-modal').style.display = 'flex';
    }

    window.buyItem = (name, cost) => {
        let p = state.players[state.turn];
        if (p.acorns >= cost) {
            loseAcorns(p, cost, false);
            p.upgrades.push(name);
            log(`<b>${p.name}</b> installed <b>${name}</b>!`);
            closeMarket();
        }
    }

    function closeMarket() { document.getElementById('market-modal').style.display = 'none'; passTurn(); }

    function triggerDuel(p1, p2, cb) {
        let r1 = Math.floor(Math.random() * 6) + 1;
        let r2 = Math.floor(Math.random() * 6) + 1;
        while(r1 === r2) r2 = Math.floor(Math.random() * 6) + 1;
        
        let win = r1 > r2 ? p1 : p2;
        let lose = r1 > r2 ? p2 : p1;
        
        showMsg("‚öîÔ∏è DUEL! ‚öîÔ∏è", `${p1.name} rolled ${r1}, ${p2.name} rolled ${r2}. ${win.name} steals 1 üå∞!`, () => {
            loseAcorns(lose, 1, false); gainAcorns(win, 1); cb();
        });
    }

    function triggerEvent(p) {
        const evs = [
            {t: "Blizzard!", f: () => moveStep(p, -3, true)},
            {t: "Gold Mine!", f: () => { gainAcorns(p, 4); passTurn(); }},
            {t: "Thief!", f: () => { 
                let richest = state.players.filter(o => o.id !== p.id).sort((a,b) => b.acorns - a.acorns)[0];
                if (richest.acorns > 0) { loseAcorns(richest, 1, false); gainAcorns(p, 1); log(`${p.name} robbed ${richest.name}!`); }
                passTurn();
            }}
        ];
        let e = evs[Math.floor(Math.random() * evs.length)];
        showMsg("EVENT", e.t, e.f);
    }

    function claimJackpot(p) {
        if (state.jackpot > 0) {
            let j = state.jackpot; state.jackpot = 0; gainAcorns(p, j);
            showMsg("üí∞ JACKPOT!", `You won the ${j} üå∞ stash!`, passTurn);
        } else passTurn();
    }

    function startTurn() {
        let p = state.players[state.turn];
        document.getElementById('turn-indicator').innerText = p.name;
        document.getElementById('turn-indicator').style.color = p.color;
        document.getElementById('btn-roll').disabled = false;
        if (state.totalTurns % 8 === 0) triggerWeather();
    }

    document.getElementById('btn-roll').addEventListener('click', () => {
        let p = state.players[state.turn];
        document.getElementById('btn-roll').disabled = true;
        
        let roll = Math.floor(Math.random() * 6) + 1;
        if (p.upgrades.includes("Turbo Engine")) roll += 2;
        if (p.upgrades.includes("Caveman")) roll += 1;

        document.getElementById('dice-overlay').style.display = 'flex';
        document.getElementById('dice-face').innerText = 'üé≤';
        
        setTimeout(() => {
            document.getElementById('dice-face').innerText = roll;
            setTimeout(() => {
                document.getElementById('dice-overlay').style.display = 'none';
                state.isAnimating = true;
                moveStep(p, roll, true);
            }, 800);
        }, 1000);
    });

    function passTurn() {
        state.turn = (state.turn + 1) % state.players.length;
        if (state.turn === 0) {
            state.totalTurns++;
            document.getElementById('turn-counter').innerText = state.totalTurns;
        }
        updateHUD(); startTurn();
    }

    function updateHUD() {
        const hud = document.getElementById('hud'); hud.innerHTML = '';
        state.players.forEach((p, i) => {
            hud.innerHTML += `
                <div class="player-card ${state.turn === i ? 'active' : ''}" style="border-left-color:${p.color}">
                    <div style="font-size:1.2rem; font-weight:900;">${p.emoji} ${p.name}</div>
                    <div style="color:var(--gold); font-weight:bold;">${p.acorns} üå∞ | Lap: ${Math.max(0, p.laps)}/3</div>
                    <div>${p.upgrades.map(u => `<span class="badge" style="color:var(--cyan)">${u}</span>`).join(' ')}</div>
                </div>`;
        });
        document.getElementById('jackpot-counter').innerText = state.jackpot;
    }

    function log(m) {
        const l = document.getElementById('log');
        l.innerHTML = `<div class="log-entry"><b>></b> ${m}</div>` + l.innerHTML;
    }

    function showFloat(p, t, c) {
        let tc = document.getElementById(`tc-${p.pos}`);
        let f = document.createElement('div');
        f.className = 'float-text'; f.innerText = t; f.style.color = c;
        let r = tc.getBoundingClientRect();
        f.style.left = r.left + 'px'; f.style.top = r.top + 'px';
        document.body.appendChild(f);
        setTimeout(() => f.remove(), 1000);
    }

    function triggerWin(p) {
        let msg = `${p.name} WON THE GAME!`;
        if (p.team) {
            let partner = state.players.find(o => o.id !== p.id && o.team === p.team);
            msg = `TEAM VICTORY! ${p.name} and ${partner.name} WIN!`;
        }
        showMsg("üèÜ CHAMPION!", msg, () => location.reload());
    }

    function triggerWeather() {
        let fx = document.getElementById('fx-layer');
        let w = ['snow', 'rain', 'clear'][Math.floor(Math.random() * 3)];
        if (w === 'clear') { fx.style.opacity = '0'; log("‚òÄÔ∏è Weather is clear."); }
        else { fx.className = 'weather-' + w; fx.style.opacity = '1'; log(`üåßÔ∏è Weather shift: ${w.toUpperCase()}`); }
    }

    function showMsg(t, s, cb) {
        const m = document.getElementById('simple-modal');
        m.style.display = 'flex';
        document.getElementById('sm-title').innerText = t;
        document.getElementById('sm-text').innerHTML = s;
        document.getElementById('modal-btn-container').innerHTML = `<button class="btn btn-cyan" onclick="closeMsg()">CONTINUE</button>`;
        window.closeMsg = () => { m.style.display = 'none'; if(cb) cb(); };
    }

    function showChoice(t, s, b) {
        const m = document.getElementById('simple-modal');
        m.style.display = 'flex';
        document.getElementById('sm-title').innerText = t;
        document.getElementById('sm-text').innerHTML = s;
        let c = document.getElementById('modal-btn-container');
        c.innerHTML = '';
        b.forEach(btn => {
            let el = document.createElement('button');
            el.className = 'btn btn-cyan'; el.style.width = 'auto'; el.style.margin = '5px';
            el.innerText = btn.text; el.onclick = () => { m.style.display = 'none'; btn.action(); };
            c.appendChild(el);
        });
    }


    function showInstructions() {
        const body = `
            <div class="instr-grid">
                <div class="instr-item"><b>Objective:</b> Be the first explorer to complete 3 laps around the board!</div>
                <div class="instr-item"><b>Laps:</b> Passing Start earns 2 acorns. <b>Beware:</b> Being pushed back past Start will lose you a lap.</div>
                <div class="instr-item"><b>Village Outpost:</b> Buy upgrades here. <b>Turbo</b> (+2 rolls), <b>Snow Tires</b> (no sliding back), and <b>Allies</b>.</div>
                <div class="instr-item"><b>Team Pact:</b> Forms an alliance with the player in last place. If either of you finishes, you both win!</div>
                <div class="instr-item"><b>Traps:</b> Bear Traps and Jaap Stops freeze you for 1 turn. Toll Bridges require 1 acorn to cross.</div>
                <div class="instr-item"><b>Duels:</b> Land on another player to initiate a duel. The winner steals an acorn!</div>
            </div>`;
        
        // Using your existing showMsg structure but targeting a new body div
        const m = document.getElementById('simple-modal');
        m.style.display = 'flex';
        document.getElementById('sm-title').innerText = "ICE AGE SURVIVAL GUIDE";
        document.getElementById('sm-text').innerHTML = body; // Changed to innerHTML to render the grid
        document.getElementById('modal-btn-container').innerHTML = `<button class="btn btn-cyan" onclick="closeMsg()">BACK TO GAME</button>`;
        window.closeMsg = () => { m.style.display = 'none'; };
    }

</script>
</body>
</html>


